@model RentalService.Models.AdPost
@using RentalService.Models
@{
    ViewData["Title"] = Model.Title;
}
<div class="container mt-4">
    <form id="hiddenViewForm" method="post" style="display:none">
        @Html.AntiForgeryToken()
    </form>
    <div class="row">
        <div class="col-md-8 order-2 order-md-1">
            <div class="d-flex justify-content-between align-items-center mb-3">
                @if (User?.Identity != null && User.Identity.IsAuthenticated && User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value == Model.HostId)
                {
                    <a href="@Url.Action("MyAdPosts", "HostAdPosts")" class="btn btn-outline-primary"><i class="fa fa-list"></i> Quản lý quảng cáo của tôi</a>
                }
                else
                {
                    <a href="@Url.Action("Index", "Home")" class="btn btn-outline-info"><i class="fa fa-arrow-left"></i> Quay lại trang chủ</a>
                }
            </div>
            <div class="mb-3">
                <h2>@Model.Title</h2>
                <span class="badge bg-primary">@Model.Badge</span>
                <span class="badge bg-info">@Model.PackageType.ToVietnameseLabel()</span>
            </div>
            <div class="mb-3">
                <div class="ad-content-html">@Html.Raw(Model.Content)</div>
            </div>
            <div class="mb-3">
                <i class="fa fa-eye"></i> @Model.ViewCount lượt xem
            </div>
            <div class="mb-4">
                <strong>Phòng quảng cáo:</strong>
                <div class="row g-4">
                @if (Model.Rooms != null && Model.Rooms.Any())
                {
                    var firstRoom = Model.Rooms.FirstOrDefault();
                    var building = firstRoom?.Building;
                }
                @if (Model.Rooms != null && Model.Rooms.Any())
                {
                    foreach (var room in Model.Rooms)
                    {
                        <div class="col-12 col-md-6 col-lg-4">
                            <div class="room-card clickable-card h-100" tabindex="0" onclick="if(event.target.tagName !== 'A' && event.target.tagName !== 'BUTTON'){ window.location='@Url.Action("Details", "Rooms", new { id = room.Id })'; }" onkeydown="if(event.key==='Enter' && event.target===this){ window.location='@Url.Action("Details", "Rooms", new { id = room.Id })'; }">
                                @if (room.RoomImages != null && room.RoomImages.Count > 0 && !string.IsNullOrEmpty(room.RoomImages[0].ImageUrl))
                                {
                                    <img src="@room.RoomImages[0].ImageUrl" alt="Room Image" class="room-card-img" onerror="this.onerror=null;this.src='/images/no-image.png';" />
                                }
                                else if (room.Images != null && room.Images.Count > 0 && !string.IsNullOrEmpty(room.Images[0].ImageUrl))
                                {
                                    <img src="@room.Images[0].ImageUrl" alt="Room Image" class="room-card-img" onerror="this.onerror=null;this.src='/images/no-image.png';" />
                                }
                                else
                                {
                                    <img src="/images/no-image.png" alt="No Image" class="room-card-img" />
                                }
                                <div class="room-card-body">
                                    <div class="room-card-title">@room.Name</div>
                                    <div class="room-card-price">@room.Price.ToString("N0") ₫</div>
                                    <div class="room-card-status mb-2">
                                        @if (room.Status.ToString() == "Active")
                                        {
                                            <span class="badge bg-success">Đang mở</span>
                                        }
                                        else if (room.Status.ToString() == "Inactive")
                                        {
                                            <span class="badge bg-secondary">Đã khóa</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning text-dark">Ẩn</span>
                                        }
                                    </div>
                                    <a href="@Url.Action("Details", "Rooms", new { id = room.Id })" class="btn btn-outline-info btn-sm room-card-link">Xem chi tiết</a>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="col-12 text-muted">Không có phòng nào được quảng cáo.</div>
                }
                </div>
            </div>
        </div>
        <div class="col-md-4 order-1 order-md-2 mb-4 mb-md-0">
            <div class="room-gallery mb-3">
                @if (!string.IsNullOrEmpty(Model.ImageUrls))
                {
                    var images = Model.ImageUrls.Split(',');
                    <div id="mainAdImage" class="mb-2">
                        <img src="@images[0]" class="img-fluid rounded shadow-sm" style="max-height:340px;object-fit:cover;width:100%;" alt="Ad Image" onerror="this.onerror=null;this.src='/images/no-image.png';" />
                    </div>
                    <div class="d-flex flex-row flex-wrap gap-2">
                        @for (int i = 0; i < images.Length; i++)
                        {
                            <img src="@images[i]" class="img-thumbnail ad-thumb" style="width:70px;height:70px;object-fit:cover;cursor:pointer;@(i==0?"border:2px solid #007bff;":"")" onclick="showAdImage('@images[i]', this)" alt="Ad Thumbnail" onerror="this.onerror=null;this.src='/images/no-image.png';" />
                        }
                    </div>
                }
                else
                {
                    <img src="/images/no-image.png" class="img-fluid rounded shadow-sm" style="max-height:340px;object-fit:cover;width:100%;" alt="No Image" />
                }
            </div>
            <div class="card p-3 mb-3">
                <div><b>Gói dịch vụ:</b> @Model.PackageType.ToVietnameseLabel()</div>
                <div><b>Ngày tạo:</b> @Model.CreatedAt.ToString("dd/MM/yyyy")</div>
                <div><b>Trạng thái:</b> @(Model.IsActive ? "Đang hiển thị" : "Đang chờ duyệt")</div>
            </div>
            @if (Model.Rooms != null && Model.Rooms.Any() && Model.Rooms.FirstOrDefault()?.Building != null)
            {
                var building = Model.Rooms.FirstOrDefault().Building;
                <div class="card p-3 mb-3">
                    <label class="fw-bold">Địa chỉ tòa nhà:</label>
                    <div class="mb-2"><i class="fa-solid fa-location-dot"></i> @building.Address</div>
                    @if (!string.IsNullOrEmpty(building.Location))
                    {
                        <a class="btn btn-outline-primary btn-sm mb-2" target="_blank" rel="noopener" href="https://www.google.com/maps/search/?api=1&query=@building.Location">
                            Mở trên Google Maps
                        </a>
                        <div id="buildingMap" style="height: 220px;"></div>
                    }
                </div>
            }
        </div>
    </div>
    @if (User?.Identity != null && User.Identity.IsAuthenticated && User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value == Model.HostId)
    {
        <a href="@Url.Action("MyAdPosts", "HostAdPosts")" class="btn btn-outline-primary mt-4"><i class="fa fa-list"></i> Quản lý quảng cáo của tôi</a>
    }
    else
    {
        <a href="@Url.Action("Index", "Home")" class="btn btn-outline-info mt-4"><i class="fa fa-arrow-left"></i> Quay lại trang chủ</a>
    }
</div>
<script>
    function showAdImage(url, thumb) {
        document.getElementById('mainAdImage').innerHTML = `<img src="${url}" class='img-fluid rounded shadow-sm' style='max-height:340px;object-fit:cover;width:100%;' alt='Ad Image' />`;
        document.querySelectorAll('.ad-thumb').forEach(t => t.style.border = '');
        thumb.style.border = '2px solid #007bff';
    }
</script>
<style>
    .ad-content-html { font-size: 1.08em; line-height: 1.7; background: #f8f9fa; border-radius: 8px; padding: 1rem 1.2rem; margin-bottom: 0.5rem; }
    .room-gallery img { transition: border 0.2s; }
    .ad-thumb:hover { border:2px solid #198754 !important; }
    .room-card { background: #fff; border-radius: 10px; box-shadow: 0 2px 8px #e9ecef; padding: 0.5rem 0.5rem 0.7rem 0.5rem; margin-bottom: 1rem; }
    .room-card-img { width: 100%; height: 180px; object-fit: cover; border-radius: 8px; box-shadow: 0 2px 6px #ccc; }
    .room-card-body { padding: 0.5rem 0.2rem 0 0.2rem; }
    .room-card-title { font-size: 1.1em; font-weight: 500; margin-bottom: 0.2rem; }
    .room-card-price { color: #198754; font-weight: 600; margin-bottom: 0.2rem; }
    .room-card-status { font-size: 0.95em; }
    .room-list-card {
        flex-direction: row;
        min-height: 120px;
        border-radius: 12px;
        overflow: hidden;
    }
    .room-list-img-wrap {
        flex: 0 0 160px;
        max-width: 160px;
        min-width: 120px;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .room-list-img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 0;
    }
</style>
<link rel="stylesheet" href="/css/room-cards.css" />
@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Tăng view count khi customer xem bài
            var isCustomer = '@(User?.Identity != null && User.Identity.IsAuthenticated && (User.FindFirst("role")?.Value == "customer"))' === 'True';
            if (isCustomer) {
                var token = document.querySelector('#hiddenViewForm input[name="__RequestVerificationToken"]').value;
                fetch('@Url.Action("IncreaseViewCount", "AdPosts", new { id = Model.Id })', {
                    method: 'POST',
                    headers: { 'RequestVerificationToken': token }
                });
            }
        });
    </script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var loc = '@(Model.Rooms != null && Model.Rooms.Any() && Model.Rooms.FirstOrDefault()?.Building != null ? Model.Rooms.FirstOrDefault().Building.Location : "")';
            if (loc) {
                var parts = loc.split(',');
                if (parts.length === 2) {
                    var lat = parseFloat(parts[0]);
                    var lng = parseFloat(parts[1]);
                    var map = L.map('buildingMap').setView([lat, lng], 16);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                    }).addTo(map);
                    L.marker([lat, lng]).addTo(map);
                }
            }
        });
    </script>
}
